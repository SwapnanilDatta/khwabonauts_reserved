<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Dashboard</title>
    <style>
       /* Reset and Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

:root {
    --bg-primary: #0a192f;
    --bg-secondary: #112240;
    --accent-primary: #64ffda;
    --text-primary: #ccd6f6;
    --text-secondary: #8892b0;
    --success-color: #4CAF50;
    --error-color: #f44336;
    --info-color: #2196F3;
    --warning-color: #ffd700;
}

body {
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 2rem;
    min-height: 100vh;
    line-height: 1.6;
}

/* Typography */
h1, h2 {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    font-weight: 600;
}

h1 {
    font-size: 2rem;
    border-bottom: 2px solid var(--accent-primary);
    padding-bottom: 0.5rem;
    width: fit-content;
}

/* Form Styles */
form {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
}

label {
    color: var(--text-secondary);
    margin-right: 0.5rem;
}

select, input {
    background: rgba(10, 25, 47, 0.7);
    border: 1px solid var(--accent-primary);
    color: var(--text-primary);
    padding: 0.5rem;
    border-radius: 4px;
    outline: none;
    transition: all 0.3s ease;
}

select:focus, input:focus {
    box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.3);
}

button[type="submit"] {
    background: rgba(100, 255, 218, 0.1);
    color: var(--accent-primary);
    border: 1px solid var(--accent-primary);
    padding: 0.5rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

button[type="submit"]:hover {
    background: rgba(100, 255, 218, 0.2);
    transform: translateY(-2px);
}

/* Table Styles */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 2rem 0;
    background: var(--bg-secondary);
    border-radius: 12px;
    overflow: hidden;
}

th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(100, 255, 218, 0.1);
}

th {
    background: rgba(10, 25, 47, 0.9);
    color: var(--accent-primary);
    font-weight: 600;
}

tr:hover {
    background: rgba(100, 255, 218, 0.05);
}

/* Links */
a {
    color: var(--accent-primary);
    text-decoration: none;
    transition: all 0.3s ease;
}

a:hover {
    text-shadow: 0 0 8px rgba(100, 255, 218, 0.3);
}

/* Button Styles */
.request-btn, button {
    background: rgba(100, 255, 218, 0.1);
    color: var(--accent-primary);
    border: 1px solid var(--accent-primary);
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.request-btn:hover, button:hover:not([disabled]) {
    background: rgba(100, 255, 218, 0.2);
    transform: translateY(-2px);
}

button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Status Colors */
.status-pending {
    color: var(--warning-color);
}

.status-accepted {
    color: var(--success-color);
}

.status-declined {
    color: var(--error-color);
}

/* Notification Styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    color: white;
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
}

.notification.success {
    background: rgba(76, 175, 80, 0.9);
}

.notification.error {
    background: rgba(244, 67, 54, 0.9);
}

.notification.info {
    background: rgba(33, 150, 243, 0.9);
}

.notification.show {
    opacity: 1;
    transform: translateY(0);
}

/* Accepted Requests Section */
#accepted-requests {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 12px;
    margin: 1rem 0;
}

#accepted-requests div {
    padding: 0.75rem;
    border-bottom: 1px solid rgba(100, 255, 218, 0.1);
}

#accepted-requests div:last-child {
    border-bottom: none;
}

/* Responsive Design */
@media (max-width: 768px) {
    body {
        padding: 1rem;
    }

    form {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }

    table {
        display: block;
        overflow-x: auto;
    }

    th, td {
        padding: 0.75rem;
    }
}
    </style>
</head>
<body>
    <!-- Notification container -->
    <div id="notification" class="notification" style="display: none;"></div>

    <h1>Priority Dashboard for {{ recipient_name }}</h1>
    <form method="POST">
        <label for="sort_by">Sort By:</label>
        <select name="sort_by" id="sort_by">
            <option value="compatibility_score">Compatibility Score</option>
            <option value="distance">Distance</option>
            <option value="urgency_score">Urgency Score</option>
        </select>

        <label for="min_score">Min Compatibility Score:</label>
        <input type="number" step="0.1" name="min_score" id="min_score" value="{{ min_score }}">

        <label for="max_distance">Max Distance (km):</label>
        <input type="number" step="0.1" name="max_distance" id="max_distance" value="{{ max_distance }}">

        <button type="submit">Apply Filters</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>Donor Name</th>
                <th>Organ</th>
                <th>Compatibility Score</th>
                <th>Urgency Score</th>
                <th>Distance</th>
                <th>Action</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr data-donor-id="{{ result.donor_id }}">
                <td><a href="/card/{{ result.donor_id }}">{{ result.donor_name }}</a></td>
                <td>{{ result.organ }}</td>
                <td>{{ result.compatibility_score }}</td>
                <td>{{ result.urgency_score }}</td>
                <td>{{ result.distance }} km</td>
                <td>
                    <button onclick="sendRequest('{{ result.donor_id }}', '{{ recipient_id }}', '{{ recipient_name }}', event)"
                            {% if result.request_status %} disabled {% endif %}>
                        {% if not result.request_status %} Request Donor {% else %} {{ result.request_status }} {% endif %}
                    </button>
                </td>
                <td class="request-status">{{ result.request_status or 'Not Requested' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Your Accepted Requests</h2>
    <div id="accepted-requests"></div>
    <div style="margin: 20px 0;">
        <a href="/map-matches/{{ recipient_id }}" 
           style="background: rgba(100, 255, 218, 0.1);
                  color: #64ffda;
                  border: 1px solid #64ffda;
                  padding: 10px 20px;
                  border-radius: 4px;
                  text-decoration: none;
                  display: inline-block;
                  transition: all 0.3s ease;">
            View Matches on Map
        </a>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const currentRecipientId = '{{ recipient_id }}'; // Store recipient ID globally

        // Function to show notifications
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // Socket.IO initialization
        const socket = io('http://127.0.0.1:5000/ws', {
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            transports: ['websocket', 'polling']
        });

        // Handle connection errors
        socket.on('connect_error', (error) => {
            console.error('Connection Error:', error);
            showNotification('Connection error. Retrying...', 'error');
        });

        // Handle reconnection events
        socket.on('reconnect', (attemptNumber) => {
            console.log(`Reconnected after ${attemptNumber} attempts`);
            showNotification('Reconnected successfully', 'success');
        });

        socket.on('connect', () => {
            console.log('Connected to WebSocket');
            socket.emit('join', { room: currentRecipientId });
            loadAcceptedRequests();
        });

        socket.on('request_update', (data) => {
            if (data.recipient_id === currentRecipientId) {
                updateRequestStatus(data.donor_id, data.status);
                loadAcceptedRequests();
            }
        });

        // Function to load accepted requests
        function loadAcceptedRequests() {
            fetch(`/accepted_requests/${currentRecipientId}`)
                .then(response => response.json())
                .then(requests => {
                    const container = document.getElementById('accepted-requests');
                    container.innerHTML = requests.map(request => `
                        <div>
                            Donor: ${request.donor_name}, Organ: ${request.organ}
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading requests:', error);
                    showNotification('Failed to load accepted requests', 'error');
                });
        }

        // Function to send a request
        function sendRequest(donorId, recipientId, recipientName, event) {
            const button = event.target;
            button.disabled = true;

            fetch('/send_request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    donor_id: donorId,
                    recipient_id: currentRecipientId,
                    recipient_name: recipientName
                })
            })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('Request sent successfully', 'success');
                        updateRequestStatus(donorId, 'Pending');
                        loadAcceptedRequests();
                    } else {
                        throw new Error(data.message || 'Failed to send request');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification(error.message, 'error');
                    button.disabled = false;
                });
        }

        // Function to update the request status
        function updateRequestStatus(donorId, status) {
            const row = document.querySelector(`tr[data-donor-id="${donorId}"]`);
            if (row) {
                const statusCell = row.querySelector('.request-status');
                const requestButton = row.querySelector('button');

                statusCell.textContent = status;
                requestButton.textContent = status;
                requestButton.disabled = true;
            }
        }

        document.addEventListener('DOMContentLoaded', loadAcceptedRequests);
    </script>
</body>
</html>
